# Supabase - Custom Domain Routing
# This handles requests for sdbl.hcai42.com and proxies them to local Supabase Kong instance
# Use http:// prefix to prevent automatic HTTPS redirect (Cloudflare Tunnel handles SSL)

http://sdbl.hcai42.com {
    # Request body size limit (10MB)
    request_body {
        max_size 10MB
    }

    # Handle preflight OPTIONS requests first
    @options {
        method OPTIONS
    }
    handle @options {
        # CORS headers for preflight responses
        header {
            Access-Control-Allow-Origin *
            Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
            Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, X-Client-Info, X-SUPABASE-API-KEY"
            Access-Control-Allow-Credentials true
            Access-Control-Max-Age 3600
        }
        respond 204
    }

    # CORS headers for all other requests
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, X-Client-Info, X-SUPABASE-API-KEY"
        Access-Control-Allow-Credentials true
        Access-Control-Max-Age 3600
    }

    # Proxy to local Supabase Kong (API Gateway)
    # Kong is exposed on 192.168.178.243:8044 (accessible from other Docker networks via host IP)
    reverse_proxy 192.168.178.243:8044 {
        header_up Host sdbl.hcai42.com
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host sdbl.hcai42.com
        # WebSocket support
        header_up Connection "upgrade"
        header_up Upgrade "websocket"
    }
}
